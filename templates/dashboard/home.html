{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard ‚Äî Lavander√≠a{% endblock %}

{% block content %}
<div class="row g-4">
  <!-- ========================== -->
  <!-- üîπ Resumen del d√≠a -->
  <!-- ========================== -->
  <div class="col-xxl-6">
    <div class="card border-0 rounded-3 bg-white mb-4 p-4">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0">Resumen de hoy</h2>
        <span class="badge bg-primary">Lavander√≠a</span>
      </div>
      <p class="text-muted mb-4">Estado general de √≥rdenes y caja.</p>

      <div class="row g-3">
        <div class="col-sm-6">
          <div class="p-3 rounded-3 border">
            <div class="d-flex align-items-center justify-content-between">
              <span class="text-secondary">√ìrdenes creadas</span>
              <span class="material-symbols-outlined">assignment</span>
            </div>
            <h3 class="mt-2 mb-0">{{ orders_today }}</h3>
          </div>
        </div>

        <div class="col-sm-6">
          <div class="p-3 rounded-3 border">
            <div class="d-flex align-items-center justify-content-between">
              <span class="text-secondary">En proceso</span>
              <span class="material-symbols-outlined">local_laundry_service</span>
            </div>
            <h3 class="mt-2 mb-0">{{ in_process }}</h3>
          </div>
        </div>

        <div class="col-sm-6">
          <div class="p-3 rounded-3 border">
            <div class="d-flex align-items-center justify-content-between">
              <span class="text-secondary">Entregas de hoy</span>
              <span class="material-symbols-outlined">task_alt</span>
            </div>
            <h3 class="mt-2 mb-0">{{ delivered_today }}</h3>
          </div>
        </div>

        <div class="col-sm-6">
          <div class="p-3 rounded-3 border">
            <div class="d-flex align-items-center justify-content-between">
              <span class="text-secondary">Ingresos (RD$)</span>
              <span class="material-symbols-outlined">paid</span>
            </div>
            <h3 class="mt-2 mb-0">{{ cash_in|floatformat:2 }}</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- ========================== -->
    <!-- üîπ √ìrdenes recientes -->
    <!-- ========================== -->
    <div class="card bg-white border-0 rounded-3 mb-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
          <h3 class="mb-0 text-secondary">√ìrdenes recientes</h3>
          <a href="{% url 'orders:list' %}" class="btn btn-sm btn-outline-primary">Ver todas</a>
        </div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr class="border-bottom">
                <th>C√≥digo</th><th>Cliente</th><th>Total</th><th>Estado</th><th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for order in recent_orders %}
                <tr>
                  <td>{{ order.code }}</td>
                  <td>{{ order.customer.name }}</td>
                  <td>RD$ {{ order.final_amount|floatformat:2 }}</td>
                  <td>
                    <span class="badge 
                      {% if order.status == 'entregado' %}bg-success
                      {% elif order.status == 'en_proceso' %}bg-warning text-dark
                      {% elif order.status == 'listo' %}bg-info
                      {% else %}bg-secondary{% endif %}">
                      {{ order.get_status_display }}
                    </span>
                  </td>
                  <td class="text-end">
                    <a href="{% url 'orders:detail' order.pk %}" class="btn btn-sm btn-light">Ver</a>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="5" class="text-center text-muted">No hay √≥rdenes recientes.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================== -->
  <!-- üîπ Columna lateral -->
  <!-- ========================== -->
  <div class="col-xxl-6">
    <div class="row g-4 mb-4">
      <!-- Inventario bajo -->
      <div class="col-md-6">
        <div class="card bg-white border-0 rounded-3 h-100">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="mb-0">Alerta de insumos</h3>
              <a href="{% url 'inventory:list' %}" class="btn btn-sm btn-outline-secondary">Ver todo</a>
            </div>
            <ul class="list-unstyled mb-0">
              {% for item in low_stock_alerts %}
                <li class="d-flex justify-content-between py-2 border-bottom">
                  <span>{{ item.name }}</span>
                  <strong class="{% if item.status == 'danger' %}text-danger{% elif item.status == 'warning' %}text-warning{% else %}text-success{% endif %}">
                    {{ item.stock }}
                  </strong>
                </li>
              {% empty %}
                <li class="text-muted">Inventario suficiente.</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Caja / clientes -->
      <div class="col-md-6">
        <div class="card bg-white border-0 rounded-3 h-100">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="mb-0">Resumen financiero</h3>
              <a href="{% url 'cash:list' %}" class="btn btn-sm btn-outline-secondary">Ver caja</a>
            </div>
            <ul class="list-unstyled mb-0">
              <li class="d-flex justify-content-between py-2 border-bottom">
                <span>Total clientes activos</span>
                <strong>{{ total_customers }}</strong>
              </li>
              <li class="d-flex justify-content-between py-2">
                <span>Balance en caja actual</span>
                <strong>RD$ {{ cash_balance|floatformat:2 }}</strong>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- ========================== -->
    <!-- üîπ Gr√°fico de √≥rdenes -->
    <!-- ========================== -->
    <div class="card bg-white border-0 rounded-3">
      <div class="card-body p-4">
        <h3 class="mb-3">√ìrdenes por estado (√∫ltimos 7 d√≠as)</h3>
        <div id="orders_chart"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'assets/js/apexcharts.min.js' %}"></script>
<script>
  const chartEl = document.querySelector('#orders_chart');
  if (chartEl) {
    const chart = new ApexCharts(chartEl, {
      chart: { type: 'bar', height: 280, toolbar: { show: false } },
      series: [{
        name: '√ìrdenes',
        data: [
          {{ chart_data.pendiente }},
          {{ chart_data.en_proceso }},
          {{ chart_data.listo }},
          {{ chart_data.entregado }}
        ]
      }],
      xaxis: { categories: ['Pendientes','En proceso','Listas','Entregadas'] },
      dataLabels: { enabled: true },
      colors: ['#f39c12','#3498db','#1abc9c','#2ecc71']
    });
    chart.render();
  }
</script>
{% endblock %}
