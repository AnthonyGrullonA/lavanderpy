{% extends "base.html" %}
{% load static %}
{% block title %}Detalle de Orden {{ order.code }}{% endblock %}

{% block content %}
<div class="main-content-container overflow-hidden">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
    <h3 class="mb-0">Orden {{ order.code }}</h3>
    <div class="d-flex gap-2">
      <a href="{% url 'orders:edit' order.pk %}" class="btn btn-outline-primary">
        <i class="ri-edit-line me-1"></i> Editar
      </a>
      <a href="{% url 'orders:list' %}" class="btn btn-outline-secondary">
        <i class="ri-arrow-left-line me-1"></i> Volver
      </a>
    </div>
  </div>

  <!-- Información General -->
  <div class="card bg-white border-0 rounded-3 mb-4">
    <div class="card-body p-4">
      <h5 class="fw-semibold mb-3">Información General</h5>

      <div class="row">
        <div class="col-md-6 mb-2">
          <strong>Cliente:</strong>
          <p class="mb-0">{{ order.customer.name }}</p>
        </div>

        <div class="col-md-3 mb-2">
          <strong>Fecha de creación:</strong>
          <p class="mb-0">{{ order.date_created|date:"d/m/Y H:i" }}</p>
        </div>

        <div class="col-md-3 mb-2">
          <strong>Estado:</strong>
          {% include "orders/_order_status_badge.html" %}
        </div>
      </div>

      <div class="mt-3">
        <strong>Notas:</strong>
        <p class="mb-0">{{ order.notes|default:"—" }}</p>
      </div>
    </div>
  </div>

  <!-- Servicios Incluidos -->
  <div class="card bg-white border-0 rounded-3 mb-4">
    <div class="card-body p-4">
      <h5 class="fw-semibold mb-3">Servicios Incluidos</h5>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th>Servicio</th>
              <th class="text-center">Cantidad</th>
              <th class="text-end">Precio Unitario</th>
              <th class="text-end">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for line in lines %}
              <tr>
                <td>{{ line.service.name }}</td>
                <td class="text-center">{{ line.quantity }}</td>
                <td class="text-end">RD$ {{ line.unit_price|floatformat:2 }}</td>
                <td class="text-end fw-semibold">RD$ {{ line.subtotal|floatformat:2 }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted py-3">No hay servicios agregados.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <hr class="my-3">
      <div class="d-flex justify-content-between fw-semibold">
        <span>Subtotal:</span>
        <span>RD$ {{ order.total_amount|floatformat:2 }}</span>
      </div>
      <div class="d-flex justify-content-between fw-semibold text-secondary">
        <span>Descuento:</span>
        <span>RD$ {{ order.discount|floatformat:2 }}</span>
      </div>
      <div class="d-flex justify-content-between fw-semibold text-primary fs-5 mt-2">
        <span>Total Final:</span>
        <span>RD$ {{ order.final_amount|floatformat:2 }}</span>
      </div>
    </div>
  </div>

  <!-- ✅ Consumo de Insumos -->
  <div class="card bg-white border-0 rounded-3 mb-4">
    <div class="card-body p-4">
      <h5 class="fw-semibold mt-4">Consumo de Insumos</h5>
      {% for block in components %}
        <p class="fw-medium">{{ block.service }}</p>
        <ul class="ms-3">
          {% for c in block.components %}
            <li>{{ c.item }}: {{ c.used }} {{ c.unit }}</li>
          {% endfor %}
        </ul>
      {% empty %}
        <p class="text-muted">Sin consumo registrado.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Timeline -->
  {% include "orders/_order_timeline.html" %}

</div>
{% endblock %}
