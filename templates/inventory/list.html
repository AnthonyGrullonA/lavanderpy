{% extends "base.html" %}
{% load static %}
{% block title %}Inventario{% endblock %}

{% block content %}
<div class="main-content-container overflow-hidden">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
    <h3 class="mb-0">Inventario</h3>
    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
      <ol class="breadcrumb align-items-center mb-0 lh-1">
        <li class="breadcrumb-item">
          <a href="{% url 'dashboard:home' %}" class="d-flex align-items-center text-decoration-none">
            <i class="ri-home-4-line fs-18 text-primary me-1"></i>
            <span class="text-secondary fw-medium hover">Dashboard</span>
          </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page"><span class="fw-medium">Inventario</span></li>
      </ol>
    </nav>
  </div>

  <!-- Tabla -->
  <div class="card bg-white border-0 rounded-3 mb-4">
    <div class="card-body p-0">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 p-4">
        <form method="get" class="position-relative table-src-form me-0">
          <input type="text" class="form-control" name="q" value="{{ query|default:'' }}" placeholder="Buscar insumo...">
          <i class="material-symbols-outlined position-absolute top-50 start-0 translate-middle-y">search</i>
        </form>
        <button class="btn btn-outline-primary py-1 px-2 px-sm-4 fs-14 fw-medium rounded-3 hover-bg"
                type="button" onclick="openCreateItem()">
          <i class="ri-add-line d-none d-sm-inline-block"></i> Agregar Insumo
        </button>
      </div>

      <div class="default-table-area style-two default-table-width">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Unidad</th>
                <th>Stock</th>
                <th>Mínimo</th>
                <th>Costo</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <td>{{ item.name }}</td>
                <td>{{ item.unit.abbreviation }}</td>
                <td>{{ item.current_stock }}</td>
                <td>{{ item.min_stock }}</td>
                <td>{{ item.cost_per_unit }} RD$</td>
                <td>
                  {% if item.is_below_minimum %}
                    <span class="badge bg-danger bg-opacity-10 text-danger p-2 fs-12">Bajo stock</span>
                  {% else %}
                    <span class="badge bg-success bg-opacity-10 text-success p-2 fs-12">Normal</span>
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex align-items-center gap-1">
                    <button type="button" onclick="openEditItem({{ item.id }})" class="border-0 bg-transparent lh-1">
                      <i class="material-symbols-outlined fs-16 text-body">edit</i>
                    </button>
                    <form method="POST" action="{% url 'inventory:deactivate' item.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="border-0 bg-transparent lh-1 text-danger"
                              onclick="return confirm('¿Desactivar este insumo?')">
                        <i class="material-symbols-outlined fs-16">block</i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="text-center py-4 text-muted">No hay insumos activos.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Offcanvas (crear/editar) -->
<div class="offcanvas offcanvas-end bg-white" tabindex="-1" id="offcanvasItem"
     aria-labelledby="offcanvasItemLabel"
     style="box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;">
  <div class="offcanvas-header bg-primary py-3 px-4">
    <h5 class="offcanvas-title fs-18 text-white" id="offcanvasItemLabel">Agregar Insumo</h5>
    <button type="button" class="btn-close text-white" data-bs-dismiss="offcanvas" aria-label="Close"
            style="filter: invert(1); opacity: 1;"></button>
  </div>
  <div class="offcanvas-body p-4" id="offcanvasItemBody">
    {% include "inventory/form.html" %}
  </div>
</div>

<!-- ✅ Script corregido -->
<script>
function openCreateItem() {
  document.getElementById("offcanvasItemLabel").innerText = "Agregar Insumo";
  const body = document.getElementById("offcanvasItemBody");
  // ✅ se elimina el force_escape para que el HTML del formulario se renderice correctamente
  body.innerHTML = `{% include "inventory/form.html" %}`;
  new bootstrap.Offcanvas('#offcanvasItem').show();
}

function openEditItem(id) {
  fetch(`/inventory/${id}/edit/`)
    .then(res => res.json())
    .then(data => {
      if (data.html) {
        document.getElementById('offcanvasItemBody').innerHTML = data.html;
        document.getElementById('offcanvasItemLabel').innerText = 'Editar Insumo';
        new bootstrap.Offcanvas('#offcanvasItem').show();
      }
    });
}

// Manejo de post-edición: redirige si el JSON devuelve redirect
document.addEventListener("submit", async function (e) {
  if (e.target.matches("form")) {
    e.preventDefault();
    const form = e.target;
    const res = await fetch(form.action, {
      method: form.method,
      body: new FormData(form),
      headers: { "X-Requested-With": "XMLHttpRequest" },
    });
    const data = await res.json();
    if (data.success && data.redirect) {
      window.location.href = data.redirect;
    } else if (data.html) {
      document.getElementById("offcanvasItemBody").innerHTML = data.html;
    }
  }
});
</script>

{% endblock %}
